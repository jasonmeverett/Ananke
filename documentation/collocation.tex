\subsection{Collocation Overview}
The decision vector for this type of multi-phase collocation is large, but not untraceable. For sake of clarity, a P-phase collocation method example will be shown with n collocation points in each phase (note: the amount of collocation points can vary per phase). It is also important to note that this matrix can be rearranged in any fashion, as some forms may bode well for NLP solving schemes that require specific gradient formats.
\begin{multicols}{2}
\begin{equation}
\vec{X}_{dv} = 
\begin{bmatrix}
\vec{R}_{[x ... z]_{[0 ... P]}} \\
\vec{V}_{[x ... z]_{[0 ... P]}} \\
\vec{U}_{[x ... z]_{[0 ... P]}} \\
\vec{m}_{[0 ... P]} \\
\vec{\eta }_{[0 ... P]} \\
\nu_0 \\
T_{[0 ... P]} \\
\end{bmatrix}
\rightarrow
\begin{bmatrix}
3 n_0 + ... + 3 n_p \\
3 n_0 + ... + 3 n_p \\
3 n_0 + ... + 3 n_p \\
n_0 + ... + n_p \\
n_0 + ... + n_p \\
1 \\
P 
\end{bmatrix}
\end{equation} 
\break
\begin{equation}
\vec{F} = 
\begin{bmatrix}
J \\
\vec{R}_0 \\
\vec{V}_0 \\
m_0 \\
\vec{R}_f \\
\vec{V}_f \\
\vec{R}_{c_{[0 ... P]}} \\
\vec{V}_{c_{[0 ... P]}} \\
\vec{m}_{c_{[0 ... P]}} \\
\vec{U}_{mag_{[0 ... P]}} \\
\vec{R}_{mag_{[0 ... P]}} \\
\vec{\eta}_{lb_{[0 ... P]}} \\
\vec{\eta}_{ub_{[0 ... P]}} \\
\nu_{lb_{0}} \\
\nu_{ub_{0}} \\
\vec{R}_{m_{[0 \rightarrow P]}} \\
\vec{V}_{m_{[0 \rightarrow P]}} \\
m_{m_{[0 \rightarrow P]}} \\
T_{lb_{[0 ... P]}} \\
T_{ub_{[0 ... P]}} \\
\end{bmatrix}
\rightarrow
\begin{bmatrix}
1 \\
3 \\
3 \\
1 \\
3 \\
3 \\
3(n_0-1) + ... + 3(n_P - 1) \\
3(n_0-1) + ... + 3(n_P - 1) \\
(n_0-1) + ... + (n_P - 1) \\
n_0 + ... + n_p \\
n_0 + ... + n_p \\
n_0 + ... + n_p \\
n_0 + ... + n_p \\
1 \\
1 \\
3 (P - 1) \\
3 (P - 1) \\
P - 1 \\
1 \\
1 \\
\end{bmatrix}
\end{equation} 
\end{multicols}
Assume an example of a 3-phase trajectory with each phase containing a total of 15 collocation points. This would lead to a decision vector with a length of 499 and a fitness/constraint vector of length  506. The constraint vector components will be described throughout the subsequent sections. The true form of the constraints may vary at mechanization depending on the NLP solver selected.


\subsection{Path Constraints}
Under trapezoidal collocation transcription, the path constraints of $N$ collocation points will take on the following form within any arbitrary phase of the trajectory:
\begin{align}
\vec{r}_{k+1} - \vec{r}_k = 
\frac{1}{2}\Delta t ( \vec{v}_{k+1} + \vec{v}_k ) &&
k \in \{ 0, ... , N-1 \}
\end{align}
\begin{align}
\vec{v}_{k+1} - \vec{v}_k = 
\frac{1}{2}\Delta t \left[ \frac{\mu }{r_{k+1}^3}\vec{r}_{k+1} + \frac{\mu }{r_{k}^3}\vec{r}_{k} +  \frac{T_m \eta_k}{m_k} \hat{u}_{k} + \frac{T_m \eta_{k+1}}{m_{k+1}} \hat{u}_{k+1} \right] &&
k \in \{ 0, ... , N-1 \}
\end{align}
\begin{align}
m_{k} - m_{k+1} = 
\frac{1}{2}\Delta t \frac{T_m}{g_0 I_{sp}} ( \eta_{k+1} + \eta_{k} ) &&
k \in \{ 0, ... , N-1 \}
\end{align}
\subsection{Boundary Constraints}
\subsubsection{Initial and Final Trajectory States}
\paragraph{}
It is required in this nonlinear program that the final targeted position and velocity remain constant in the planet-fixed frame. This requirement transcribes itself into a nonlinear equality constraint on the last collocation point of the last phase of the trajectory. In phase $P$ of $P$ with $N$ collocation points:
\begin{equation}
\vec{r}_{N_{p}}^{I} = \vec{r}_{t/c}^{I} = C_{\mathit{UEN}}^{I} \vec{r}_{t/c}^{\mathit{UEN}}
\end{equation}
\begin{equation}
\vec{v}_{N_{p}}^{I} = \vec{v}_{t/c}^{I} + \vec{\Omega} \times \vec{r}_{t/c}^{I} = C_{\mathit{UEN}}^{I} \vec{v}_{t/c}^{\mathit{UEN}} + \vec{\Omega} \times \vec{r}_{t/c}^{I}
\end{equation}
Where  $\vec{r}_{t/c}^{\mathit{UEN}}$ represents the target position vector expressed in the $\mathit{UEN}$ frame (which is a fixed offset from the $\mathit{LS}$ frame).
\paragraph{}
Also, for this problem, it is assumed that the initial orbit of the vehicle is fixed - that is, of the 6 necessary parameters to fully constrain an orbital state expressed in Kelperian elements, only the initial true anomaly of the orbit is allowed to be optimized. This allows for simpler derivation of partials, but requires that the vehicle's initial state always begin in a reference orbital plane. Choosing true anomaly $\nu$ as a decision vector parameter is the simplest way to approach this for both constraint and partial development. Given a certain right-ascension of the ascending node $\Omega$, inclination $i$, eccentricity $e$, semi-major axis $a$ and argument of periapsis $\omega$, the starting position and velocity constraint can be expressed as a function of $\nu$ through the following equations:
\begin{equation}\label{eq:state0pos}
\vec{r}_0 = R_z (-\Omega) R_x(-i) R_z(-\omega) \vec{o}
\end{equation}
\begin{equation}\label{eq:state0vel}
\vec{v}_0 = R_z (-\Omega) R_x(-i) R_z(-\omega) \dot{\vec{o}}
\end{equation}
Where:
\begin{equation}
E = 2 \arctan{\left(\sqrt{\frac{1-e}{1+e}} \tan{\frac{\nu}{2}}\right)}
\end{equation}
\begin{equation}
r_c = a(1 - e \cos{E})
\end{equation}
\begin{align}
\vec{o} = r_c \begin{bmatrix}
\cos {\nu} \\ \sin {\nu} \\ 0
\end{bmatrix} &&
\dot{\vec{o}} = \frac{\sqrt{\mu a}}{r_c} 
\begin{bmatrix}
-\sin {E} \\ \sqrt{1 - e^2} \cos{E} \\ 0
\end{bmatrix}
\end{align}
\paragraph{}
The partials of the initial state constraint equations \ref{eq:state0pos} and \ref{eq:state0pos} is a laborious process but can be sped up with a symbolic mathematics toolbox. Or, one can do it manually, if he's up to the challenge. So, starting with $\vec{o}$:
\begin{equation}
\dv{}{\nu}\left[ \vec{o} \right] = 
\dv{}{\nu}\left\{     a \left(1 - e \cos{E} \right)
\begin{bmatrix}
\cos {\nu} \\ \sin {\nu} \\ 0
\end{bmatrix}  \right\}
\end{equation}
\begin{equation}
\dv{}{\nu}\left[ \vec{o} \right] = 
-e \dv{}{\nu} \left[ \cos{E} \right]
\begin{bmatrix}
-\sin {\nu} \\ \cos {\nu} \\ 0
\end{bmatrix} 
\end{equation}
\begin{equation}
\dv{}{\nu}\left[ \vec{o} \right] = 
e \sin{(E)} \dv{E}{\nu}
\begin{bmatrix}
-\sin {\nu} \\ \cos {\nu} \\ 0
\end{bmatrix} 
\end{equation}
\begin{align}
\dv{E}{\nu} = \frac{2}{1 + B^2} \dv{B}{\nu} &&
B = \sqrt{\frac{1-e}{1+e}} \tan{\frac{\nu}{2}}
\end{align}
\begin{align}
\dv{B}{\nu} = \frac{1}{2}  \sqrt{\frac{1-e}{1+e}}  \sec^2{\frac{\nu}{2}}
\end{align}

Now, for $\dot{\vec{o}}$:
\begin{equation}
\dv{}{\nu}\left[ r_c \right] = e \sin{(E)} \dv{E}{\nu}
\end{equation}
\begin{equation}
\dv{}{\nu}\left[ \dot{\vec{o}} \right] = \sqrt{\mu a}  \dv{}{\nu} \left\{  
\begin{bmatrix}
\frac{-\sin {E}}{r_c} \\ \frac{\sqrt{1 - e^2} \cos{E}}{r_c} \\ 0
\end{bmatrix}
\right\}
\end{equation}
Then, solve for the vector. Okay, now we're done with those!

\subsubsection{Phase Boundary Constraints}
At the boundaries of each phase, a constraint is set on the state of the vehicle. In other words, for phase $i$ with $n$ segments and phase $i+1$ as the subsequent phase, the following constraints must be met:
\begin{equation}
\vec{R}_{n_{i}} = \vec{R}_{0_{i+1}}
\end{equation}
\begin{equation}
\vec{V}_{n_{i}} = \vec{V}_{0_{i+1}}
\end{equation}
For mass continuity, there are two forms of mass constraints that can be employed. The first is representative of a fixed mass drop between phases:
\begin{equation}
m_{n_{i}} = m_{0_{i+1}} + \Delta m_{i,i+1}
\end{equation}
where $\Delta m_{i,i+1}$ is a mass drop that is allowed to occur from phase $i$ to phase $i+1$. This phase delta could provide use if a fixed-mass component of the vehicle must be jettisoned at a phase boundary. Another form that is more synonymous to a staging of a vehicle includes an inequality constraint on the final propellant mass of phase $i$ along with an equality constraint on the initial mass of phase $i+1$:
\begin{equation}
mp_{n_{i}} \geq 0
\end{equation}
\begin{equation}
mp_{0_{i}} = mp_{\mathit{init}_{i+1}}
\end{equation}
\subsubsection{Other Constraints}
Altitude constraint:
\begin{equation}
R_x^2 + R_y^2 + R_z^2 - R_{min}^2 >= 0
\end{equation}
Throttling constraints:
\begin{equation}
\eta_{lb} <= \eta_{k}
\end{equation}
\subsection{Partials}
The following is a list of partials that must be calculated for a P-phase system with a total decision vector of $\vec{X}$ and a fitness vector of $\vec{F}$.

\begin{equation}
\pdv{\vec{X}}{\vec{F}} = 
\begin{bmatrix}

[0] &
[0] &
\pdv{J}{\vec{U}_{[x,y,z]_{[0,1,2]}}} &
\pdv{J}{\vec{m}_{[0,1,2]}} &
\pdv{J}{\vec{\eta}_{[0,1,2]}} &
\pdv{J}{T_{[0,1,2]}} &
[0]  \\

\pdv{\vec{R}_0}{\vec{R}_{[x,y,z]_{[0,1,2]}}} &
[0] &
[0] &
[0] &
[0] &
[0] &
\pdv{\vec{R}_0}{\nu_0}  \\

[0] &
\pdv{\vec{V}_0}{\vec{V}_{[x,y,z]_{[0,1,2]}}} &
[0] &
[0] &
[0] &
[0] &
\pdv{\vec{V}_0}{\nu_0}  \\

[0] &
[0] &
[0] &
\pdv{m_0}{\vec{m}_{[0,1,2]}} &
[0] &
[0] &
[0]  \\

\pdv{\vec{R}_f}{\vec{R}_{[x,y,z]_{[0,1,2]}}} &
[0] &
[0] &
[0] &
[0] &
\pdv{\vec{R}_f}{T_{[0,1,2]}} &
[0]  \\

[0] &
\pdv{\vec{V}_f}{\vec{V}_{[x,y,z]_{[0,1,2]}}} &
[0] &
[0] &
[0] &
\pdv{\vec{V}_f}{T_{[0,1,2]}} &
[0]  \\

\pdv{\vec{R}_{c_{[0,1,2]}}}{\vec{R}_{[x,y,z]_{[0,1,2]}}} &
\pdv{\vec{R}_{c_{[0,1,2]}}}{\vec{V}_{[x,y,z]_{[0,1,2]}}} &
[0] &
[0] &
[0] &
\pdv{\vec{R}_{c_{[0,1,2]}}}{T_{[0,1,2]}} &
[0]  \\

\pdv{\vec{V}_{c_{[0,1,2]}}}{\vec{R}_{[x,y,z]_{[0,1,2]}}} &
\pdv{\vec{V}_{c_{[0,1,2]}}}{\vec{V}_{[x,y,z]_{[0,1,2]}}} &
\pdv{\vec{V}_{c_{[0,1,2]}}{\vec{U}_{[x,y,z]_{[0,1,2]}}}} &
\pdv{\vec{V}_{c_{[0,1,2]}}}{\vec{m}_{[0,1,2]}} &
\pdv{\vec{V}_{c_{[0,1,2]}}}{\vec{\eta}_{[0,1,2]}} &
\pdv{\vec{V}_{c_{[0,1,2]}}}{T_{[0,1,2]}} &
[0]  \\

[0] &
[0] &
[0] &
\pdv{\vec{m}_{c_{[0,1,2]}}}{\vec{m}_{[0,1,2]}} &
\pdv{\vec{m}_{c_{[0,1,2]}}}{\vec{\eta}_{[0,1,2]}} &
\pdv{\vec{m}_{c_{[0,1,2]}}}{T_{[0,1,2]}} &
[0]  \\

[0] &
[0] &
\pdv{\vec{U}_{mag_{[0,1,2]}}}{\vec{U}_{[x,y,z]_{[0,1,2]}}} &
[0] &
[0] &
[0] &
[0]  \\

\pdv{\vec{R}_{mag_{[0,1,2]}}}{\vec{R}_{[x,y,z]_{[0,1,2]}}} &
[0] &
[0] &
[0] &
[0] &
[0] &
[0]  \\

[0] &
[0] &
[0] &
[0] &
\pdv{\vec{\eta}_{lb_{[0,1,2]}}}{\vec{\eta}_{[0,1,2]}} &
[0] &
[0]  \\

[0] &
[0] &
[0] &
[0] &
\pdv{\vec{\eta}_{ub_{[0,1,2]}}}{\vec{\eta}_{[0,1,2]}} &
[0] &
[0]  \\

[0] &
[0] &
[0] &
[0] &
[0] &
[0] &
\pdv{\nu_{lb_0}}{\nu_0} \\

[0] &
[0] &
[0] &
[0] &
[0] &
[0] &
\pdv{\nu_{ub_0}}{\nu_0} \\

\pdv{\vec{R}_{[0 \rightarrow 1, 1 \rightarrow 2]}}{\vec{R}_{[x,y,z]_{[0,1,2]}}} &
[0] &
[0] &
[0] &
[0] &
[0] &
[0]  \\

[0] &
\pdv{\vec{V}_{[0 \rightarrow 1, 1 \rightarrow 2]}}{\vec{V}_{[x,y,z]_{[0,1,2]}}} &
[0] &
[0] &
[0] &
[0] &
[0]  \\

[0] &
[0] &
[0] &
\pdv{m_{[0 \rightarrow 1, 1 \rightarrow 2]}}{\vec{m}_{[0,1,2]}} &
[0] &
[0] &
[0]  \\

[0] &
[0] &
[0] &
[0] &
[0] &
\pdv{T_{lb_{[0,1,2]}}}{T_{[0,1,2]}} &
[0]  \\

[0] &
[0] &
[0] &
[0] &
[0] &
\pdv{T_{ub_{[0,1,2]}}}{T_{[0,1,2]}} &
[0]  \\
\end{bmatrix}
\end{equation}

It is important to note that the partial matrix above is for the minimum-control problem. For the minimum-fuel problem, $\pdv{J}{\vec{U}_{[x,y,z]_{[0,1,2]}}}$ and $\pdv{J}{\vec{m}_{[0,1,2]}}$ null to zero matrices if the objective function is used that is specified above.

